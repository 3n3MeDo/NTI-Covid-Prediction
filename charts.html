<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 | Advanced Analytics</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Outfit"', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#0B1121', surface: '#151E32', border: '#2A3655' },
                        primary: { DEFAULT: '#0EA5E9', glow: '#38BDF8' },
                        accent: { purple: '#8B5CF6', rose: '#F43F5E', em: '#10B981', amber: '#F59E0B' }
                    },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B1121; color: #E2E8F0; }
        .glass-panel {
            background: rgba(21, 30, 50, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
        }
        .glass-panel:hover {
            border-color: rgba(14, 165, 233, 0.3);
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-20 bg-[#0F1629] border-r border-[#1E293B] flex flex-col items-center py-8 z-50 hidden md:flex">
        <a href="/" class="w-12 h-12 mb-8 rounded-xl bg-gray-800 flex items-center justify-center hover:bg-rose-500 hover:text-white hover:shadow-[0_0_15px_rgba(244,63,94,0.3)] transition-all text-gray-400">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div class="w-12 h-12 rounded-xl bg-rose-500/10 text-rose-500 border border-rose-500/20 flex items-center justify-center relative">
            <i class="fa-solid fa-chart-pie text-lg"></i>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        
        <header class="h-20 px-8 flex items-center justify-between border-b border-[#1E293B] bg-[#0B1121]/80 backdrop-blur-md">
            <div>
                <h1 class="text-2xl font-bold tracking-tight text-white flex items-center gap-3">
                    COVID-19 <span class="text-rose-500 font-extrabold">INSIGHTS</span>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-rose-500/10 text-rose-500 border border-rose-500/20">DATASET V1.0</span>
                </h1>
            </div>
            <div id="connectionStatus" class="flex items-center gap-2 text-xs font-mono text-slate-500">
                <span class="w-2 h-2 rounded-full bg-slate-600 animate-pulse"></span> CONNECTING...
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-blue-500/5 rounded-bl-full transition-all group-hover:bg-blue-500/10"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Records</p>
                    <h3 id="kpiTotal" class="text-4xl font-black text-white">--</h3>
                    <div class="mt-2 text-xs text-blue-400 font-mono">100% COVERAGE</div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-rose-500/5 rounded-bl-full transition-all group-hover:bg-rose-500/10"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Positive Cases</p>
                    <h3 id="kpiPositive" class="text-4xl font-black text-white">--</h3>
                    <div class="mt-2 text-xs text-rose-400 font-mono flex items-center gap-2">
                        <i class="fa-solid fa-virus"></i> CONFIRMED
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-emerald-500/5 rounded-bl-full transition-all group-hover:bg-emerald-500/10"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Negative Cases</p>
                    <h3 id="kpiNegative" class="text-4xl font-black text-white">--</h3>
                    <div class="mt-2 text-xs text-emerald-400 font-mono flex items-center gap-2">
                        <i class="fa-solid fa-shield-virus"></i> CLEARED
                    </div>
                </div>
            </div>

            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass-chart text-primary"></i> Correlations</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-white">Biometric Signature</h3>
                        <i class="fa-solid fa-bullseye text-primary text-xl opacity-50"></i>
                    </div>
                    <div class="relative h-72 w-full"><canvas id="radarChart"></canvas></div>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                     <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-white">Infection Clusters</h3>
                        <i class="fa-solid fa-braille text-accent-purple text-xl opacity-50"></i>
                    </div>
                    <div class="relative h-72 w-full"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>

            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-users-viewfinder text-accent-amber"></i> Demographics & Lifestyle</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Gender vs Result</h3>
                    <div class="relative h-60 w-full"><canvas id="genderChart"></canvas></div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Smoking Status</h3>
                    <div class="relative h-60 w-full"><canvas id="smokerChart"></canvas></div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Risk Factors</h3>
                    <div class="relative h-60 w-full flex items-center justify-center"><canvas id="polarChart"></canvas></div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl mb-8">
                <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Age Group Analysis</h3>
                <div class="relative h-64 w-full"><canvas id="ageChart"></canvas></div>
            </div>

            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-emerald-400"></i> Geography & Health</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Infection by City</h3>
                    <div class="relative h-72 w-full"><canvas id="cityChart"></canvas></div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4 text-sm uppercase tracking-wide">Comorbidity Impact</h3>
                    <div class="relative h-72 w-full"><canvas id="diseaseCountChart"></canvas></div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Config Charts Default
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#1e293b';
        Chart.defaults.font.family = '"Outfit", sans-serif';
        
        const COLORS = {
            pos: '#F43F5E', // Rose
            posFade: 'rgba(244, 63, 94, 0.7)',
            neg: '#10B981', // Emerald
            negFade: 'rgba(16, 185, 129, 0.7)'
        };

        async function initDashboard() {
            try {
                const res = await fetch('/api/stats');
                if(!res.ok) throw new Error("API Failed");
                const data = await res.json();
                
                if(data.error) throw new Error(data.error);

                updateKPIs(data.summary);
                
                // Existing Charts
                renderRadar(data.averages);
                renderScatter(data.scatter);
                renderPolar(data.risk_distribution);
                
                // NEW Charts
                renderGroupedBar('genderChart', data.distributions.gender, 'Gender');
                renderGroupedBar('smokerChart', data.distributions.smoker, 'Smoking');
                renderGroupedBar('ageChart', data.distributions.age, 'Age Groups');
                renderGroupedBar('cityChart', data.distributions.city, 'City');
                renderGroupedBar('diseaseCountChart', data.distributions.disease_count, 'Disease Count');

                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></span> LIVE DATA LINK';
                document.getElementById('connectionStatus').className = "flex items-center gap-2 text-xs font-mono text-emerald-400";

            } catch (e) {
                console.error(e);
                document.getElementById('connectionStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-rose-500"></span> DATA LINK OFFLINE';
                document.getElementById('connectionStatus').className = "flex items-center gap-2 text-xs font-mono text-rose-500";
            }
        }

        function updateKPIs(data) {
            document.getElementById('kpiTotal').textContent = data.total.toLocaleString();
            document.getElementById('kpiPositive').textContent = data.positive.toLocaleString();
            document.getElementById('kpiNegative').textContent = data.negative.toLocaleString();
        }

        // --- Generic Renderers for New Charts ---

        function renderGroupedBar(canvasId, dataObj, labelPrefix) {
            // dataObj structure: { 'Male': {positive: 10, negative: 5}, ... }
            const labels = Object.keys(dataObj);
            const posData = labels.map(l => dataObj[l].positive || 0);
            const negData = labels.map(l => dataObj[l].negative || 0);

            new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Positive',
                            data: posData,
                            backgroundColor: COLORS.pos,
                            borderRadius: 4
                        },
                        {
                            label: 'Negative',
                            data: negData,
                            backgroundColor: COLORS.neg,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: '#1e293b' } }
                    },
                    plugins: { legend: { labels: { usePointStyle: true, boxWidth: 6 } } },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        // --- Existing Chart Renderers ---

        function renderRadar(data) {
            const maxVals = { temperature_C: 40, age: 90, inflammatory_marker: 50, symptom_duration_days: 15 };
            const norm = (val, cat) => (val / maxVals[cat]) * 100;

            const posData = [
                norm(data.positive.temperature_C, 'temperature_C'),
                norm(data.positive.age, 'age'),
                norm(data.positive.inflammatory_marker, 'inflammatory_marker'),
                norm(data.positive.symptom_duration_days, 'symptom_duration_days')
            ];
            const negData = [
                norm(data.negative.temperature_C, 'temperature_C'),
                norm(data.negative.age, 'age'),
                norm(data.negative.inflammatory_marker, 'inflammatory_marker'),
                norm(data.negative.symptom_duration_days, 'symptom_duration_days')
            ];

            new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: ['Temp', 'Age', 'Inflamm.', 'Duration'],
                    datasets: [
                        { label: 'Positive Profile', data: posData, borderColor: COLORS.pos, backgroundColor: 'rgba(244, 63, 94, 0.2)', borderWidth: 2 },
                        { label: 'Negative Profile', data: negData, borderColor: COLORS.neg, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { angleLines: { color: '#1e293b' }, grid: { color: '#1e293b' }, pointLabels: { color: '#cbd5e1', font: {size: 11, weight: 'bold'} }, ticks: { display: false } } },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }

        function renderScatter(data) {
            new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Positive', data: data.filter(d => d.type === 'positive'), backgroundColor: COLORS.pos, pointRadius: 4 },
                        { label: 'Negative', data: data.filter(d => d.type === 'negative'), backgroundColor: COLORS.neg, pointRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Temperature', color: '#64748b' }, grid: { color: '#1e293b' } },
                        y: { title: { display: true, text: 'Inflam. Marker', color: '#64748b' }, grid: { color: '#1e293b' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }

        function renderPolar(data) {
            const labels = Object.keys(data);
            const posCounts = labels.map(l => data[l].positive || 0);
            new Chart(document.getElementById('polarChart'), {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{ data: posCounts, backgroundColor: ['rgba(16, 185, 129, 0.6)', 'rgba(56, 189, 248, 0.6)', 'rgba(244, 63, 94, 0.6)'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { grid: { color: '#1e293b' }, ticks: { display: false, backdropColor: 'transparent' } } },
                    plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                }
            });
        }

        initDashboard();
    </script>
</body>
</html>